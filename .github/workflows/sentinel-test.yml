# .github/workflows/sentinel-test.yml
name: "Sentinel Lab"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write       # <--- NECESSÃRIO PARA CRIAR BRANCH E COMMIT
  pull-requests: write  # <--- NECESSÃRIO PARA ABRIR PR E COMENTAR

jobs:
  lab-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Importante para o histÃ³rico do git

      # 1. Roda o Sentinel (Gera a PR de relatÃ³rio)
      - name: Run Sentinel
        id: sentinel
        uses: Malnati/code-literal-sentinel@v2.5.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Opcional: customizar diretÃ³rio
          report_dir: "reports/audit"

      # 2. Notifica na PR original com Template Rico
      - name: Notify
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          template_path: .github/workflows/pr-comment-sentinel.md # <--- NOVO TEMPLATE
          message_id: "sentinel-report"
          
          header_title: "ğŸ‘ï¸ Code Literal Sentinel"
          header_subject: "RelatÃ³rio de Auditoria"
          header_actor: "github-actions[bot]"
          
          # O Sentinel v2 retorna a mensagem e o link jÃ¡ formatados no JSON
          body_message: |
            ### ${{ fromJson(steps.sentinel.outputs.result_json).ui.message }}
            
            ${{ fromJson(steps.sentinel.outputs.result_json).ui.guidance }}
          
          footer_result: ${{ fromJson(steps.sentinel.outputs.result_json).analysis.status == 'FOUND' && 'âš ï¸ RevisÃ£o NecessÃ¡ria' || 'âœ… CÃ³digo Limpo' }}
          footer_advise: "Siga o link acima para ver os detalhes."
            
      # --------------------------------------------------------
      # 3. DEBUG (Mantivemos para vocÃª ver o log)
      # --------------------------------------------------------
      - name: Inspect Engine Outputs
        run: |
          echo "::group::ğŸ” Engine Outputs"
          echo "Status: ${{ steps.ops.outputs.status }}"
          echo "URL: ${{ steps.ops.outputs.pr_url }}"
          echo "::endgroup::"
  
      # --------------------------------------------------------
      # 4. NOTIFICAÃ‡ÃƒO (Visual Profissional)
      # --------------------------------------------------------
      - name: Notify User
        # Comenta se publicou (PUBLISHED) ou se detectou que jÃ¡ existe (SKIPPED_IDEMPOTENT)
        if: steps.ops.outputs.status == 'PUBLISHED' || steps.ops.outputs.status == 'SKIPPED_IDEMPOTENT'
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          # Aponta para o novo template
          template_path: .github/workflows/pr-comment-ops.md 
          # ID Ãºnico para atualizar o mesmo comentÃ¡rio sempre
          message_id: "ops-engine-report" 
          
          header_title: "âš™ï¸ Git Report Ops"
          header_subject: "Status de PublicaÃ§Ã£o"
          header_actor: "github-actions[bot]"
          
          # Montagem da Tabela HTML para o corpo da mensagem
          body_message: |
            <div align="center">
            
            | ğŸ“¡ Status da OperaÃ§Ã£o | ğŸ”— Acesso ao RelatÃ³rio |
            | :---: | :---: |
            | **${{ steps.ops.outputs.status == 'PUBLISHED' && 'âœ… Publicado/Atualizado' || 'â¸ï¸ Sem alteraÃ§Ãµes' }}** | **[Ver Pull Request de RelatÃ³rio](${{ steps.ops.outputs.pr_url }})** |
            
            </div>
            
            <br>
            
            > **Detalhes TÃ©cnicos:**
            > * **Status Code:** `${{ steps.ops.outputs.status }}`
            > * **Engine:** `Malnati/git-report-ops@v1`
          
          footer_result: ${{ steps.ops.outputs.status == 'PUBLISHED' && 'âœ… Sucesso' || 'â„¹ï¸ Idempotente' }}
          footer_advise: "Clique no link da tabela para revisar o conteÃºdo."
