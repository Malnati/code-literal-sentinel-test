# .github/workflows/sentinel-test.yml
name: "Sentinel Lab"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write       # <--- NECESSÃRIO PARA CRIAR BRANCH E COMMIT
  pull-requests: write  # <--- NECESSÃRIO PARA ABRIR PR E COMENTAR

jobs:
  lab-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Importante para o histÃ³rico do git

      # 1. Roda o Sentinel (Gera a PR de relatÃ³rio)
      - name: Run Sentinel
        id: sentinel
        uses: Malnati/code-literal-sentinel@v2.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Opcional: customizar diretÃ³rio
          report_dir: "reports/audit"

      # 2. Notifica na PR original com Template Rico
      - name: Notify
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          template_path: .github/workflows/pr-comment-sentinel.md # <--- NOVO TEMPLATE
          message_id: "sentinel-report"
          
          header_title: "ðŸ‘ï¸ Code Literal Sentinel"
          header_subject: "RelatÃ³rio de Auditoria"
          header_actor: "github-actions[bot]"
          
          # O Sentinel v2 retorna a mensagem e o link jÃ¡ formatados no JSON
          body_message: |
            ### ${{ fromJson(steps.sentinel.outputs.result_json).ui.message }}
            
            ${{ fromJson(steps.sentinel.outputs.result_json).ui.guidance }}
          
          footer_result: ${{ fromJson(steps.sentinel.outputs.result_json).analysis.status == 'FOUND' && 'âš ï¸ RevisÃ£o NecessÃ¡ria' || 'âœ… CÃ³digo Limpo' }}
          footer_advise: "Siga o link acima para ver os detalhes."
