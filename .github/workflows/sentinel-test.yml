# .github/workflows/sentinel-test.yml
name: "Sentinel Lab"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
    - nunca

permissions:
  contents: write       # <--- NECESS√ÅRIO PARA CRIAR BRANCH E COMMIT
  pull-requests: write  # <--- NECESS√ÅRIO PARA ABRIR PR E COMENTAR

jobs:
  lab-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Importante para o hist√≥rico do git

      # 1. Roda o Sentinel (Gera a PR de relat√≥rio)
      - name: Run Sentinel
        id: sentinel
        uses: Malnati/code-literal-sentinel@v2.5.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Opcional: customizar diret√≥rio
          report_dir: "reports/audit"

      # 2. Notifica na PR original com Template Rico
      - name: Notify
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          template_path: .github/workflows/pr-comment-sentinel.md # <--- NOVO TEMPLATE
          message_id: "sentinel-report"
          
          header_title: "üëÅÔ∏è Code Literal Sentinel"
          header_subject: "Relat√≥rio de Auditoria"
          header_actor: "github-actions[bot]"
          
          # O Sentinel v2 retorna a mensagem e o link j√° formatados no JSON
          body_message: |
            ### ${{ fromJson(steps.sentinel.outputs.result_json).ui.message }}
            
            ${{ fromJson(steps.sentinel.outputs.result_json).ui.guidance }}
          
          footer_result: ${{ fromJson(steps.sentinel.outputs.result_json).analysis.status == 'FOUND' && '‚ö†Ô∏è Revis√£o Necess√°ria' || '‚úÖ C√≥digo Limpo' }}
          footer_advise: "Siga o link acima para ver os detalhes."
            
      # --------------------------------------------------------
      # 3. DEBUG (Mantivemos para voc√™ ver o log)
      # --------------------------------------------------------
      - name: Inspect Engine Outputs
        run: |
          echo "::group::üîç Engine Outputs"
          echo "Status: ${{ steps.ops.outputs.status }}"
          echo "URL: ${{ steps.ops.outputs.pr_url }}"
          echo "::endgroup::"
  
      # --------------------------------------------------------
      # 4. NOTIFICA√á√ÉO (Visual Profissional)
      # --------------------------------------------------------
      - name: Notify User
        # Comenta se publicou (PUBLISHED) ou se detectou que j√° existe (SKIPPED_IDEMPOTENT)
        if: steps.ops.outputs.status == 'PUBLISHED' || steps.ops.outputs.status == 'SKIPPED_IDEMPOTENT'
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          # Aponta para o novo template
          template_path: .github/workflows/pr-comment-ops.md 
          # ID √∫nico para atualizar o mesmo coment√°rio sempre
          message_id: "ops-engine-report" 
          
          header_title: "‚öôÔ∏è Git Report Ops"
          header_subject: "Status de Publica√ß√£o"
          header_actor: "github-actions[bot]"
          
          # Montagem da Tabela HTML para o corpo da mensagem
          body_message: |
            <div align="center">
            
            | üì° Status da Opera√ß√£o | üîó Acesso ao Relat√≥rio |
            | :---: | :---: |
            | **${{ steps.ops.outputs.status == 'PUBLISHED' && '‚úÖ Publicado/Atualizado' || '‚è∏Ô∏è Sem altera√ß√µes' }}** | **[Ver Pull Request de Relat√≥rio](${{ steps.ops.outputs.pr_url }})** |
            
            </div>
            
            <br>
            
            > **Detalhes T√©cnicos:**
            > * **Status Code:** `${{ steps.ops.outputs.status }}`
            > * **Engine:** `Malnati/git-report-ops@v1`
          
          footer_result: ${{ steps.ops.outputs.status == 'PUBLISHED' && '‚úÖ Sucesso' || '‚ÑπÔ∏è Idempotente' }}
          footer_advise: "Clique no link da tabela para revisar o conte√∫do."
