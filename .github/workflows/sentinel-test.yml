# .github/workflows/sentinel-test.yml
name: "Sentinel Lab"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write # Permiss√£o adicionada

jobs:
  lab-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Roda o Scanner
      - name: Run Code Literal Sentinel
        id: sentinel
        uses: Malnati/code-literal-sentinel@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output_file: "audit/detected_literals.txt"

      # 2. Debug (Opcional, mas √∫til)
      - name: Inspect Outputs
        run: |
          echo "::group::üîç JSON Payload"
          echo '${{ steps.sentinel.outputs.result_json }}' | jq .
          echo "::endgroup::"

      # 3. Upload do Artefato
      - name: Upload Index Artifact
        if: ${{ fromJson(steps.sentinel.outputs.result_json).analysis.status == 'FOUND' }}
        uses: actions/upload-artifact@v4
        with:
          name: raw-literals-index
          path: ${{ steps.sentinel.outputs.index_path }}

      # 4. Comentar na PR (Integration Test)
      - name: Report Findings
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          message_id: "literal-sentinel-report"
          
          header_title: "üëÅÔ∏è Code Literal Sentinel"
          header_subject: "An√°lise de Qualidade"
          header_actor: "github-actions[bot]"
          
          # Renderiza a mensagem din√¢mica gerada pelo Sentinel
          body_message: |
            ### ${{ fromJson(steps.sentinel.outputs.result_json).ui.message }}
            
            ${{ fromJson(steps.sentinel.outputs.result_json).ui.guidance }}
            
            <details>
            <summary>Ver Detalhes (Raw Index)</summary>
            
            O arquivo completo foi anexado aos artefatos desta execu√ß√£o.
            Total de ocorr√™ncias: ${{ fromJson(steps.sentinel.outputs.result_json).analysis.total_findings }}
            
            </details>
          
          footer_result: ${{ fromJson(steps.sentinel.outputs.result_json).analysis.status == 'FOUND' && '‚ö†Ô∏è An√°lise Necess√°ria' || '‚úÖ Limpo' }}
          
          footer_advise: "Verifique se estes valores devem ir para vari√°veis de ambiente."
