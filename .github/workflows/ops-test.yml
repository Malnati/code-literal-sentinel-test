# .github/workflows/ops-test.yml
name: "üêô Git Ops Lab"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write       # Necess√°rio para a Engine fazer push
  pull-requests: write  # Necess√°rio para a Engine abrir PR e o Comment postar

jobs:
  engine-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # CR√çTICO: A engine precisa disso para verificar hist√≥rico e evitar loops

      # --------------------------------------------------------
      # 1. SIMULA√á√ÉO: Gerar um relat√≥rio fake
      # --------------------------------------------------------
      - name: üìã Generate Dummy Report
        run: |
          mkdir -p artifacts
          REPORT_FILE="artifacts/dummy_report.md"
          
          echo "# üß™ Relat√≥rio de Teste da Engine" > "$REPORT_FILE"
          echo "Este arquivo foi gerado dinamicamente para testar o **git-report-ops**." >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Dados do Contexto" >> "$REPORT_FILE"
          echo "- **Data:** $(date)" >> "$REPORT_FILE"
          echo "- **Commit:** ${{ github.sha }}" >> "$REPORT_FILE"
          echo "- **Runner:** ${{ runner.os }}" >> "$REPORT_FILE"
          
          echo "Report gerado em: $REPORT_FILE"

      # --------------------------------------------------------
      # 2. EXECU√á√ÉO DA ENGINE (Git Report Ops)
      # --------------------------------------------------------
      - name: üì¢ Publish via Ops Engine
        id: ops
        # ATEN√á√ÉO: Atualizado para a vers√£o com o fix cr√≠tico
        uses: Malnati/git-report-ops@v1.3.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          report_file: "artifacts/dummy_report.md"
          
          # --- CONFIGURA√á√ÉO DE UI DA PR ---
          report_branch_prefix: "ops/dummy-report"
          pr_title: "üß™ Relat√≥rio de Integra√ß√£o: Ops Engine"
          pr_template_path: .github/workflows/pr-body-report.md
          pr_body: "Este relat√≥rio cont√©m dados fict√≠cios gerados durante o teste automatizado do workflow."

      # --------------------------------------------------------
      # 3. DEBUG: Ver o que a Engine retornou
      # --------------------------------------------------------
      - name: üîé Inspect Engine Outputs
        run: |
          echo "::group::üîç Engine Outputs"
          echo "Status: ${{ steps.ops.outputs.status }}"
          echo "URL: ${{ steps.ops.outputs.pr_url }}"
          echo "::endgroup::"
          
      # --------------------------------------------------------
      # 4. NOTIFICA√á√ÉO (Op√ß√£o A: Customizada via pr-comment)
      # Nota: A v1.3.1 j√° notifica automaticamente se achar relat√≥rio antigo (4.1/4.2)
      # ou se criar um novo (4.4). Este passo aqui √© opcional se voc√™ quiser
      # uma mensagem diferente ou refor√ßar o status no teste.
      # --------------------------------------------------------
      # Se voc√™ quiser testar a notifica√ß√£o AUTOM√ÅTICA da engine, remova este passo.
      # Se quiser manter uma notifica√ß√£o de controle do teste, mantenha assim:
      
      - name: üîî Notify User (Test Control)
        # S√≥ comenta se houve publica√ß√£o ou atualiza√ß√£o
        if: steps.ops.outputs.status == 'PUBLISHED'
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          template_path: .github/workflows/pr-comment-ops.md
          message_id: "ops-engine-test-control"
          
          header_title: "‚öôÔ∏è Git Ops Lab (Control)"
          header_subject: "Valida√ß√£o de Teste"
          header_actor: "github-actions[bot]"
          
          body_message: |
            <div align="center">
            
            | üì° Status da Opera√ß√£o | üîó Acesso ao Relat√≥rio |
            | :---: | :---: |
            | **${{ steps.ops.outputs.status == 'PUBLISHED' && '‚úÖ Publicado' || '‚è∏Ô∏è Sem altera√ß√µes' }}** | **[Ver Pull Request](${{ steps.ops.outputs.pr_url }})** |
            
            </div>
          
          footer_result: ‚úÖ Teste Conclu√≠do
          footer_advise: "Verifique se a PR de relat√≥rio foi criada corretamente."
