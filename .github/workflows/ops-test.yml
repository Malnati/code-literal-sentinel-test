# 
name: "ðŸ™ Git Ops Lab"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write       # NecessÃ¡rio para a Engine fazer push
  pull-requests: write  # NecessÃ¡rio para a Engine abrir PR e o Comment postar

jobs:
  engine-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # CRÃTICO: A engine precisa disso para verificar histÃ³rico e evitar loops

      # --------------------------------------------------------
      # 1. SIMULAÃ‡ÃƒO: Gerar um relatÃ³rio fake
      # Em um caso real, aqui rodaria o ESLint, PyTest, etc.
      # --------------------------------------------------------
      - name: ðŸ“‹ Generate Dummy Report
        run: |
          mkdir -p artifacts
          REPORT_FILE="artifacts/dummy_report.md"
          
          echo "# ðŸ§ª RelatÃ³rio de Teste da Engine" > "$REPORT_FILE"
          echo "Este arquivo foi gerado dinamicamente para testar o **git-report-ops**." >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Dados do Contexto" >> "$REPORT_FILE"
          echo "- **Data:** $(date)" >> "$REPORT_FILE"
          echo "- **Commit:** ${{ github.sha }}" >> "$REPORT_FILE"
          echo "- **Runner:** ${{ runner.os }}" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## SimulaÃ§Ã£o de Erros" >> "$REPORT_FILE"
          echo "- âš ï¸ Erro simulado na linha 42" >> "$REPORT_FILE"
          echo "- âœ… Teste passou na linha 88" >> "$REPORT_FILE"
          
          echo "Report gerado em: $REPORT_FILE"

      # --------------------------------------------------------
      # 2. EXECUÃ‡ÃƒO DA ENGINE (Git Report Ops)
      # --------------------------------------------------------
      - name: ðŸ“¢ Publish via Ops Engine
        id: ops
        uses: Malnati/git-report-ops@v1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          report_file: "artifacts/dummy_report.md"
          
          # PersonalizaÃ§Ã£o da PR de destino
          report_branch_prefix: "ops/dummy-report"
          pr_title: "ðŸ§ª Teste de IntegraÃ§Ã£o: Ops Engine"
          pr_body: "Este Ã© um relatÃ³rio fictÃ­cio para validar a action Malnati/git-report-ops."
          
          # ConfiguraÃ§Ãµes de assinatura (Opcional, usando defaults neste teste)
          # scan_extensions: ...

      # --------------------------------------------------------
      # 3. DEBUG: Ver o que a Engine retornou
      # --------------------------------------------------------
      - name: ðŸ”Ž Inspect Engine Outputs
        run: |
          echo "::group::ðŸ” Engine Outputs"
          echo "Status: ${{ steps.ops.outputs.status }}"
          echo "URL: ${{ steps.ops.outputs.pr_url }}"
          echo "::endgroup::"

      # --------------------------------------------------------
      # 4. NOTIFICAÃ‡ÃƒO (Consumindo os outputs da Engine)
      # --------------------------------------------------------
      - name: ðŸ”” Notify User
        # SÃ³ comenta se houve publicaÃ§Ã£o ou atualizaÃ§Ã£o. Ignora se foi skipped (idempotente/loop).
        if: steps.ops.outputs.status == 'PUBLISHED'
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          message_id: "ops-engine-test"
          
          header_title: "âš™ï¸ Git Report Ops"
          header_subject: "Teste de PublicaÃ§Ã£o"
          header_actor: "github-actions[bot]"
          
          body_message: |
            A engine publicou o relatÃ³rio com sucesso.
            
            > **Status:** `${{ steps.ops.outputs.status }}`
          
          footer_result: âœ… Sucesso
          footer_advise: "[Clique aqui para ver o RelatÃ³rio](${{ steps.ops.outputs.pr_url }})"
