# .github/workflows/ops-test.yml
name: "üêô Git Ops Lab"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write       # Necess√°rio para a Engine fazer push
  pull-requests: write  # Necess√°rio para a Engine abrir PR e o Comment postar

jobs:
  engine-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # CR√çTICO: A engine precisa disso para verificar hist√≥rico e evitar loops

      # --------------------------------------------------------
      # 1. SIMULA√á√ÉO: Gerar um relat√≥rio fake
      # Em um caso real, aqui rodaria o ESLint, PyTest, etc.
      # --------------------------------------------------------
      - name: üìã Generate Dummy Report
        run: |
          mkdir -p artifacts
          REPORT_FILE="artifacts/dummy_report.md"
          
          echo "# üß™ Relat√≥rio de Teste da Engine" > "$REPORT_FILE"
          echo "Este arquivo foi gerado dinamicamente para testar o **git-report-ops**." >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Dados do Contexto" >> "$REPORT_FILE"
          echo "- **Data:** $(date)" >> "$REPORT_FILE"
          echo "- **Commit:** ${{ github.sha }}" >> "$REPORT_FILE"
          echo "- **Runner:** ${{ runner.os }}" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Simula√ß√£o de Erros" >> "$REPORT_FILE"
          echo "- ‚ö†Ô∏è Erro simulado na linha 42" >> "$REPORT_FILE"
          echo "- ‚úÖ Teste passou na linha 88" >> "$REPORT_FILE"
          
          echo "Report gerado em: $REPORT_FILE"

      # --------------------------------------------------------
      # 2. EXECU√á√ÉO DA ENGINE (Git Report Ops)
      # --------------------------------------------------------
      - name: üì¢ Publish via Ops Engine
        id: ops
        uses: Malnati/git-report-ops@v1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          report_file: "artifacts/dummy_report.md"
          
          # Personaliza√ß√£o da PR de destino
          report_branch_prefix: "ops/dummy-report"
          pr_title: "üß™ Teste de Integra√ß√£o: Ops Engine"
          pr_body: "Este √© um relat√≥rio fict√≠cio para validar a action Malnati/git-report-ops."
          
          # Configura√ß√µes de assinatura (Opcional, usando defaults neste teste)
          # scan_extensions: ...

      # --------------------------------------------------------
      # 3. DEBUG: Ver o que a Engine retornou
      # --------------------------------------------------------
      - name: üîé Inspect Engine Outputs
        run: |
          echo "::group::üîç Engine Outputs"
          echo "Status: ${{ steps.ops.outputs.status }}"
          echo "URL: ${{ steps.ops.outputs.pr_url }}"
          echo "::endgroup::"
          
      # --------------------------------------------------------
      # 4. NOTIFICA√á√ÉO (Consumindo os outputs da Engine)
      # --------------------------------------------------------
      - name: üîî Notify User
        if: steps.ops.outputs.status == 'PUBLISHED'
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          
          # --- ADICIONE ESTA LINHA AQUI ---
          template_path: .github/workflows/pr-comment-ops.md
          # --------------------------------
          
          message_id: "ops-engine-test"
          header_title: "‚öôÔ∏è Git Report Ops"
          header_subject: "Teste de Publica√ß√£o"
          header_actor: "github-actions[bot]"
          
          # Como o template j√° tem a tabela e o Tip, aqui passamos apenas os dados
          # Ou podemos passar a tabela aqui se o template esperar ${BODY_MESSAGE}
          body_message: |
            <div align="center">
            
            | üì° Status da Opera√ß√£o | üîó Acesso ao Relat√≥rio |
            | :---: | :---: |
            | **${{ steps.ops.outputs.status == 'PUBLISHED' && '‚úÖ Publicado/Atualizado' || '‚è∏Ô∏è Sem altera√ß√µes' }}** | **[Ver Pull Request de Relat√≥rio](${{ steps.ops.outputs.pr_url }})** |
            
            </div>
            
            <br>
            
            > **Detalhes T√©cnicos:**
            > * **Status Code:** `${{ steps.ops.outputs.status }}`
          
          footer_result: ‚úÖ Sucesso
          footer_advise: "Clique no link da tabela para revisar o conte√∫do."
